### ECDHE加密过程
离散对数DH
临时设置秘钥DHE
使用ECC算法ECDHE
[https://blog.csdn.net/m0_50180963/article/details/113061162](https://blog.csdn.net/m0_50180963/article/details/113061162)

# 概述

## 物理层

为数据链路层提供物理连接，传输透明的**比特流**

尽可能屏蔽掉不同传输媒体和通信手段之间的差异

### 相关定义

模拟信号：连续的

数字信号：离散的

信道：表示向某一方向发送信息的媒体，往往包含一条发送信道和接收信道

传输方式：串行传输/并行传输/

​	同步传输：外同步（单独的时钟信号）内同步（时钟信号一起编码）

编码\调制方式

传输速率

常见协议：IEEE802，IEEE802.2

## 数据链路层

建立和管理节点之间的链接，通过各种控制协议将不可靠有差错的物理信号转换为可靠的无差错是数据帧

PPP：点对点协议，只检查差错，不纠正差错，不使用序号，不进行流量控制

ASDL：非对称用户线路，电话入网的协议，上传和下载的速率不同

PPPoE：以太网点对点协议，身份验证，加密和压缩

## 3.网络层

数据的包装、寻址和路由，是通信子网的最高层

IP，ARP，RARP，ICMP

## 4.传输层

端到端的流差错和流量控制，往下是通信子网，往上是资源子网

TCP/UDP



## 5.会话层

用户程序和网络之间的接口，组织和协调用户（进程）间的通信

DNS,SSL,TLS

## 6.表示层

对命令和数据进行解释，对语法赋予含义，比如编码，格式转换，加密解密



## 7.应用层

为应用提供网络服务

HTTP/SMTP/FTP



# 相关问题



## TCP可靠性传输

### 重传机制

#### 1.传输应答机制

发送端的数据到达接收端的时候，接收端的主机会返回一个确认映带消息，表示收到消息

#### 2.超时重传

发送数据的时候设置一个定时器，超过指定时间没有接收到ACK的时候，就会重发这个数据

**RTT**(Round-Trip Time)往返时延

**RTO**(Re-transmission Timeout)超时重传时间

#### 3.快速重传

当收到三个相同的ACK的手重传丢失的报文

#### 4.SACK选择性重传

TCP头部【选项】字段SACK，将缓存图发送给发送方，通知发送方那些数据到达

#### 5.D-SACK

通知发送方那些数据被重复接收了



### 滑动窗口

解决问题：即使往返时间较长，也不会降低网络通信效率

实现：开辟一个缓存空间，接收确认应答返回之前在缓存区中保留已发送的数据

窗口大小：TCP头里包含一个字段Window，也就是窗口大小，告诉发送端缓冲区还能接收的数据有多少

发送窗口不能超过接收窗口

发送窗口：两个部分发送窗口(已发送未确认)/可用窗口(未发送但是大小允许)



### 流量控制

TCP的机制，让发送方根据接收方的接受能力控制发送的数据量

#### 窗口关闭死锁

TCP的接收方阻止发送方发送过多的数据，窗口大小为0的时候就会组织发送方发送数据，知道窗口非0，这个过程是窗口关闭过程

这时接收方完成了数据处理，等待发送方发送新的数据，但是发送方的窗口被设置为了0，等待接收放到数据，形成了死锁

**解决**：每个连接加一个定时器，接收到零窗口通知的时候启动，定时发送探测报文，确认窗口大小

#### 糊涂窗口

接收方太忙，一直不能即使取走窗口的数据，导致发送方窗口越来越小，接收方仅有几个字节的窗口，发送方也会发送这个小数据（造成的问题是延时，失去了窗口的意义）

**解决**：

接收方不发送小窗口给发送方，小于一定阈值的时候，直接设为0

发送方避免小数据：为了利用带宽，尽可能发送足够大的数据块

Nagle算法：未确认数据发送的时候，让发送器把数据发送到缓存，攒到一定程度再发送

### 拥塞控制

避免发送方发送的数据占据网络

**拥塞窗口**：发送方维护的一个状态变量，根据网络的拥塞程度动态变化



#### 慢启动

拥塞窗口cwd 慢启动门限ssthresh

发送方每收到一个ACK，拥塞窗口就会翻倍，达到慢启动门限后，进入拥塞避免算法

#### 拥塞避免

拥塞窗口达到慢启动门限后，cwd线性增长

#### 拥塞发生

超时重传的发生的时候

慢启动门限设为此时拥塞窗口的一半，拥塞窗口变为1，进入慢启动状态

#### 快速恢复

发生快重传

拥塞窗口减半，慢启动阈值设为相同的值，进入快回复阶段



## TCP

### 三次握手

1. 第一个SYN报文
   客户端初始化序列号client_isn，信号位SYN置1，进入SYN-SENT状态
2. 第二个SYN+ACK报文
   服务器的SYN和ACK标志，服务器端的初始化序列号，服务器的确认应答号，服务器进入SYN-RCVD状态
3. 第三个ACK报文
   客户端的确认应答好，ACK标志，进入establish状态

三次握手可以阻止重复历史连接的初始化（主要原因）：就的SYN延迟到达，需要客户端通过服务器端的ack号确定

三次握手可以同步双方的初始序列号

三次握手可以用避免资源浪费



### 四次挥手

1. 客户端发送FIN报文
   客户端转换FIN-WAIT-1
2. 服务器恢复ack报文
   服务端转换为close_wait,客户端转换为FIN_WAIT2
3. 服务器发送FIN报文
   服务端转换LAST_ACK
4. 客户端回复ACK报文
   TIME_WAIT一定时间释放，服务器释放

### 为什么四次挥手

两端关闭连接不一致，单端的关闭都需要一次发送和回应





### 为什么等待2MSL

MSL是报文最大生存时间，如果超过这个时间，说明报文被丢弃，没有收到说明一来一回的报文被丢弃

### 为什么需要TIME-WAIT

发起关闭的一方有TIME-WAIT状态

1. 保证ACK被对方收到
2. 防止新链接被关闭

### TIME-WAIT的危害

1. 内存资源占用
2. 端口资源占用



# HTTP/HTTPS

## HTTP

报文格式(请求行)header+body

### 优点：灵活易于扩展

请求方法、URI/URL、状态码、投资端每个组成都没有被固定死，允许自定义和扩充

HTTP在应用层，下层可以随意变化

HTTPS是在HTTP和TCP之间增加了SSL/TSL



### 缺点：无状态，明文，不安全

无状态

服务器不会存储HTTP状态，这能减轻服务器负担，但是关联性操作会比较麻烦

明文传输

http是字符串明文，可以直接查看

不安全

明文/不验证身份/无法验证完整性



TTP: Hyper Text Transfer Protocol超文本传输协议
HTTPS: Hyper Text Transfer Protocol Secure超文本安全传输协议
SSL: Secure Socket Layer 安全套接字
TSL: Transport Layer Security 安全传输层协议

SSL记录协议（SSL Record Protocol）：它建立在可靠的传输协议（如TCP）之上，为高层协议提供数据封装、压缩、加密等基本功能的支持。
SSL握手协议（SSL Handshake Protocol）：它建立在SSL记录协议之上，用于在实际的数据传输开始前，通讯双方进行身份认证、协商加密算法、交换加密密钥等。



## HTTPS

在TCP和HTTP网络层之间加入SSL/TLS安全协议，使得报文能够加密传输

HTTPS在TCP三次握手后，还需要进行SSL/TLS握手过程，才进行加密报文传输

HTTP端口号是80，HTTPS端口号是443

HTTPS协议需要向CA()申请数字证书，保证服务器身份可信



### 特点

信息加密

校验机制

身份证书



### 优点

传输过程中，使用秘钥加密



认证用户和服务器，确保数据发送到正确的用户和服务器

### 缺点

增加了握手的延时，

需要CA证书，加密解密需要CPU资源

### 加密方式

#### 对称加密

加密速度快，唯一的秘钥，但是秘钥交换需要保证安全

#### 非对称加密

密钥有两个，公钥和私钥，前者用于加密和解签名，后者用于解密和签名，缺点是速度慢



#### 混合加密

HTTPS就是使用的混合加密

#### 验证流程

1. 发起HTTP请求连接到server端口
2. Server将自己的信息以数字证书的形式返回给Client
3. 验证整数
4. 生成随机密码
   浏览器生成随机对称的密钥，并用公钥加密，让server用死要解密，解密后对密钥进行传输
5. 生成对称加密算法



#### 数字证书的获取过程

1. 根据==服务器公钥==、证书颁发者等信息用哈希算法得到H1
2. H1用==CA私钥==进行签名，得到签名证书
3. 客户端用户同样的信息经过同样的哈希算法得到H2
4. 使用==CA公钥==解签名数字证书，取出服务器公钥同时验证真实性



#### DNS解析

查看浏览器缓存

查看host文件

DNS调用，请求本地域名服务器

请求根域名服务器（只记录顶级域名服务器的地址）

请求顶级域名服务器

请求权威域名服务器







#### 输入URL到回显的整个过程

1. URL本地缓存
2. DNS解析
3. TCP连接
4. 发送请求
5. 获取响应
6. 根据结果进行处理，失败显示错误，成功回显内容
   1. 解析HTML
   2. 创建DOM树
   3. 并行加载图片/CSS等
   4. 当遇到js的时候，会阻塞的加载和执行JS
7. 关闭连接

### HTTP请求的方法

1. `GET`获取资源，幂等
2. `POST`提交数据，影响服务器
3. `HEAD`仅要求服务器返回头部信息
4. `PUT`上传数据
5. `DELTE`删除资源
6. `TRACE`回显请求内容
7. `CONNECT`用于把连接改为TCP/IP管道
8. `OPTION`返回服务器对URL支持的请求方法
9. `PATCH`PUT方法的补充，对已知资源的局部更新



### GET和POST的区别

1. 定义上区分
2. 参数保存上区分，长度限制
3. 安全和幂等操作
4. 浏览器缓存
5. 请求过程，头尾一起发还是先发头



### HTTP keep-alive

连接重用

在请求头中加入keep-alive

HTTP可以以此连接多次请求，不等返回，因为socket是全双工的通信

HTTP无状态



### Cookie和session

#### Cookie

第一次登录服务器后，将一些数据给浏览器

浏览器将数据保存在本地

后面发送请求的时候，会把请求存储的Cookle发送给服务器

服务器通过这个数据判断用户

**特点**：数据有限不会超过4KB，而且会占据HTTP的请求头

#### Session

和cookie类似，但是保存在服务器上，安全但是会占用更多的资源







### HTTP版本特性

#### HTTP1.1

1. 默认持久连接
2. 管线化，可以发送多个HTTP请求，不用等待响应
3. 断点续传，Range头域

#### HTTP2.0

1. 二进制数据
2. 多路复用，每个请求对应一个ID，
3. header压缩，encoder减少了Head的大小，缓存header字段表
4. 服务端推送，一些资源会一起发送给客户端，客户端不需要再次请求，但也需要客户端先向服务器建立连接

### HTTP优化方案

TCP连接复用/内容缓存

文本数据压缩/TCP缓冲

#### HTTP1.1问题

- 延迟不能下降，大段的连续数据传输效率更高

- 并发连接有限
- 队头阻塞
- 头部过长
- 服务器被动传输消息

#### 优化手段

- 大图切割
- 编码外部文件
- js代码打包
- 资源域名分散



### HTTP2.0

#### 头部压缩

##### 静态字典

高频出现的字符串和字段建立静态表，写入http2.0的框架里

##### 动态编码表

通信过程维护动态表

##### HPACK

##### 哈夫曼编码



#### 分帧

一个链接有多个stream

一个stream传输多个message

一个message包含多个frame



#### 服务器推送

服务器推送资源的时候，会通过PUSH_PROMISE帧传输HTTP头部，并通过特殊字段告诉哪个Stream发送包体

### HTTP3

#### http2的缺点（主要算是TCP协议的缺点）

队头阻塞

TCP和TLS握手延时

网络迁移需要重新连接（TCP的连接元组IPx2、端口x2，（协议））

#### QUIC

无队头阻塞：QUIC分了多个窗口

连接建立

QUIC只需要确认连接ID





#### HTTP3

1. 头部不在定义stream，直接使用QUIC的stream
2. 头部压缩算法HPACK->QPACK
3. 静态表增加
4. 动态表

QPACK有两个特殊的单向流，只有一端可以发送消息。

- 一个Encoder Stream将字典传递给对方，客户端用这个stream发送字典
- 一个Decoder Stream用于响应对方，说明字典已经更新

这两个单向流用于同步双方编码



### TCP与UDP的区别

|          | TCP                              | UDP                                   |
| -------- | -------------------------------- | ------------------------------------- |
| 连接     | 面向连接                         | 不需要连接                            |
| 服务形式 | 一对一，端到端                   | 一对一，一对多，多对多                |
| 可靠性   | 保证数据交付                     | 不保证可靠性                          |
| 连接控制 | 流量控制，拥塞控制               | 不会控制速率                          |
| 首部大小 | 默认20字节，有长度选项           | 固定八个字节                          |
| 传输方式 | 字节流，没有边界                 | 分包                                  |
| 分片方式 | 超过MSS，TCP分片传输，传输层合并 | UDP的分片在网络层，实际上是IP进行分片 |

### 三次握手

1. 避免历史连接
2. 同步序列号
3. SYN攻击
   过多的SYN，半连接队列沾满
   **避免方式**
   修改半连接队列大小
   计算Cookie确认ack合法性

### TIME_WAIT的作用

1. 防止关闭新链接
2. 确保对方的连接关闭（在于最后ack可能丢包）

### TCP保活机制

一段时间TCP连接无活动的时候，启动保活机制，隔一段时间发送一个探测报文，等待响应

**机制**

对端响应，重置保活时间

程序崩溃，响应RST报文，重置TCP连接

报文不可达，一定次数后关闭连接



### 流量控制的原因

接收端处理数据的速度，网速

缓冲区大小



### TCP头部

16源端口16目的端口

32序列号

32应答号

4首部长度6保留URG|ACK|PSH|RST|SYN|FIN 窗口大小

16校验和 16紧急指针

变长选项最长40字节（TCP包20-60字节）

### 重传机制

RTT round-trip time 往返时延

RTO 超时重传时间

### TCP延迟与Nagle算法

**Nagle算法**

没有已发送未确认的报文时，立刻发送

存在未确认的报文时，直到【没有已发送未确认报文】或【数据长度达到MSS大小】时没发送数据（相当于滑动窗口“失效”）

不满足条件中的一条的时候，发送方囤积数据





**延时确认**

有响应数据发送的时候，ACK会随着响应数据一起发送给对方

没有响应数据的时候，等待一段时间才会ACK

如果等待时间内，有新的数据报文到达，会发送新的



### TCP连接优化

客户端：设置SYN重传次数

服务器：设置半连接长度

设置SYN+ACK重传次数

设置accept队列长度（建立连接后，会把连接从半连接队列移入accept队列）

绕过三次握手

TCP Fast Open功能可以绕过三次握手

### TCP连接关闭

关闭方式有两种RST和FIN报文

如果进程异常退出，内核发送RST报文来关闭，不需要四次挥手流程，是暴力关闭连接的方式

安全关闭连接通过四次挥手



#### close和shutdown的区别

close是完全关闭连接，读端和写端都会关闭

shutdown可以选择单独关闭读写或者全部关闭

套接字的连接实际对应着内核的文件资源，close是减少资源的引用个数，当资源的引用为0的时候才会调用shutdown关闭连接



由于 TCP 是双全⼯的协议，所以是会出现两⽅同时关闭连接的现象，也就是同时发送了 FIN报⽂。
此时，上⾯介绍的优化策略仍然适⽤。两⽅发送 FIN 报⽂时，都认为⾃⼰是主动⽅，所以都进⼊了 FIN_WAIT1 状态， FIN 报⽂的᯿发次数仍由 tcp_orphan_retries 参数控制。
接下来，双⽅在等待 ACK 报⽂的过程中，都等来了 FIN 报⽂。这是⼀种新情况，所以连接会进⼊⼀种叫做 CLOSING 的新状态，它替代了 FIN_WAIT2 状态。接着，双⽅内核回复 ACK确认对⽅发送通道的关闭后，进⼊ TIME_WAIT 状态，等待 2MSL 的时间后，连接⾃动关闭。



## IP

MAC的作用

实现【直连】设备之间的通信

IP的作用

在【没有直连】的两个网络之间进行通信传输

### IP地址分类

A类0+7位网络号

B类10+14位网络号

C类110+21为网络号

D类1110+组播地址

E类1111+ 代用地址



主机号全为0只某个网络

全为1指所有主机，用于广播



D类地址没有主机号用于多播，E类是预留地址

多播地址用于将包发送给指定组内的所有主机，由于广播无法穿透路（广播的主机地址全为1，但是路由器不会转发广播包），如果想给其他网段发送同样的包，就可以使用可以穿透路由的多播。

224.0.0.0 ~ 224.0.0.255 为预留的组播地址，只能在局域⽹中，路由器是不会进⾏转发的。
224.0.1.0 ~ 238.255.255.255 为⽤户可⽤的组播地址，可以⽤于 Internet 上。
239.0.0.0 ~ 239.255.255.255 为本地管理组播地址，可供内部⽹在内部使⽤，仅在特定的本地范围内有效





### DNS



### ARP

ARP询问和响应包

需要找到mac地址的主机，差缓存，广播包

收到广播的响应ARP

接收响应ARP，更新缓存



### RARP

类似，RARP请求和响应



### DHCP动态获取IP地址

客户端广播DHCP发现报文，目的地址255.255.255.255:67，源地址0.0.0.0:68

DHCP服务器收到发现报文的时候，用DHCP向客户端做出响应，依然使用广播的方式，发出DHCP提供报文，提供IP地址，子网掩码和网关

客户端收到DHCP提供报文的手，从中选择一个服务器，向选中服务器发送DHCP请求报文

服务端用DHCP ACK报文对请求响应

#### 中继代理

DHCP客户端发送给DHCP中继代理的请求包会被中继代理以单播的方式发给DHCP服务器



### NAT网络地址转换

NAT穿透，客户端通过NAT设备获取IP，自行转换



### ICMP

确认目标是否可达，报告IP包废弃原因



### DNS查询方式

递归查询

迭代查询

非递归查询：DNS服务器对客户端的查询进行缓存

### RPC远端过程调用

客户端向调用本地函数一样的调用服务端的函数