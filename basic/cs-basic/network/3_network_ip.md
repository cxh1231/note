## 1、网络层概述

**网络层** 是整个互联网的核心，因此应当让网络层尽可能简单。

**网络层** 向上只提供简单灵活的、无连接的、尽最大努力交互的数据报服务。

使用 `IP` 协议，可以把异构的物理网络连接起来，使得在网络层看起来好像是一个统一的网络。

与 `IP` 协议配套使用的还有三个协议：

- **地址解析协议** `ARP`（Address Resolution Protocol）
- **网际控制报文协议** `ICMP`（Internet Control Message Protocol）
- **网际组管理协议** `IGMP`（Internet Group Management Protocol）

## 2、IP 协议

### 2.1 IP 协议概述

`IP`**协议**（Internet Protocol）又被称为**互联网协议**，是支持网间互联的数据包协议，工作在**网际层**，主要目的就是为了**提高网络的可扩展性**。

通过**网际协议IP**，可以把参与互联的，性能各异的网络**看作一个统一的网络**。

![image-20220916160330507](https://img.zxdmy.com/2022/202209161603036.png)

和**传输层**`TCP`相比，**网络层的`IP`协议是一种无连接/不可靠、尽力而为的数据包传输服务**，和`TCP`协议一起构成了 `TCP/IP` 协议的核心。

### 2.2 IP 协议的作用

`IP` 协议主要有**寻址和路由**、**分段和重组** 两个作用：

**寻址和路由**：在IP数据报中携带源IP地址和目的IP地址来表示该数据包的源主机和目标主机。IP数据报在传输过程中，每个中间节点（IP网关、路由器）只根据网络地址来进行转发，如果中间节点是路由器，则路由器会根据路由表选择合适的路径。IP协议根据路由选择协议提供的路由信息对IP数据报进行转发，直至目标主机。

**分段和重组**：IP数据报在传输过程中可能会经过不同的网络，在不同的网络中数据报的最大长度限制是不同的，IP协议通过给每个IP数据报分配一个标识符以及分段与组装的相关信息，使得数据报在不同的网络中能够被传输，被分段后的IP数据报可以独立地在网络中进行转发，在达到目标主机后由目标主机完成重组工作，恢复出原来的IP数据报。

### 2.3 IP 数据报格式

![image-20220829170802897](https://img.zxdmy.com/2022/202208291708879.png)

### 2.4 IP 地址的分类

一般认为 `IP 地址 = {<网络号>，<主机号>}`：

+ **网络号**：它标志主机所连接的网络地址表示属于互联网的哪一个网络。
+ **主机号**：它标志主机地址表示其属于该网络中的哪一台主机。

`IP` 地址分为 A，B，C，D，E 五大类：

![image-20220829170900190](https://img.zxdmy.com/2022/202208291709540.png)

+ A 类地址 (1~126)：以 0 开头，网络号占前 8 位，主机号占后面 24 位。
+ B 类地址 (128~191)：以 10 开头，网络号占前 16 位，主机号占后面 16 位。
+ C 类地址 (192~223)：以 110 开头，网络号占前 24 位，主机号占后面 8 位。
+ D 类地址 (224~239)：以 1110 开头，保留为多播地址。
+ E 类地址 (240~255)：以 1111开头，保留位为将来使用

## 3、ARP 协议

`ARP` **协议**（`Address Resolution Protocol`，**地址解析协议**），它是用于**实现 `IP` 地址到 `MAC` 地址的映射**。

![image-20220916162814794](https://img.zxdmy.com/2022/202209161628953.png)

在通信过程中，IP 数据报的源地址和目的地址始终不变，而 MAC 地址随着链路的改变而改变。

ARP 实现由 IP 地址得到 MAC 地址。

![image-20220829171024186](https://img.zxdmy.com/2022/202208291710236.png)

**ARP 协议的工作流程** 如下：

1. 首先，每台主机都会在自己的 ARP 缓冲区中建立一个 ARP 列表，以表示 IP 地址和 MAC 地址的对应关系。
2. 当源主机需要将一个数据包要发送到目的主机时，会首先检查自己的 ARP 列表，是否存在该 IP 地址对应的 MAC 地址：
  1. 如果有，就直接将数据包发送到这个MAC 地址；
  2. 如果没有，就向本地网段发起一个 ARP 请求的广播包，查询此目的主机对应的 MAC 地址。
  3. 此 ARP 请求的数据包里，包括源主机的 IP 地址、硬件地址、以及目的主机的 IP 地址。
3. 网络中所有的主机收到这个 ARP 请求后，会检查数据包中的目的 IP 是否和自己的 IP 地址一致。如果不相同，就会忽略此数据包；如果相同，该主机首先将发送端的 MAC 地址和 IP 地址添加到自己的 ARP 列表中，如果 ARP 表中已经存在该 IP 的信息，则将其覆盖，然后给源主机发送一个 ARP 响应数据包，告诉对方自己是它需要查找的 MAC 地址。
4. 源主机收到这个 ARP 响应数据包后，将得到的目的主机的 IP 地址和 MAC 地址添加到自己的 ARP 列表中，并利用此信息开始数据的传输。如果源主机一直没有收到 ARP 响应数据包，表示 ARP 查询失败。

## 4、ICMP 协议

`ICMP`（`Internet Control Message Protocol`） ，**网际控制报文协议**。

ICMP 是为了更有效地转发 IP 数据报和提高交付成功的机会。它封装在 IP 数据报中，但是不属于高层协议。

![image-20220829171054209](https://img.zxdmy.com/2022/202209021158403.png)

+ ICMP 协议是一种面向**无连接**的协议，用于**传输出错报告控制信息**。

+ 它是一个非常重要的协议，它对于网络安全具有极其重要的意义。它属于网络层协议，主要用于在主机与路由器之间传递控制信息，包括报告错误、交换受限控制和状态信息等。

+ 当遇到 IP 数据无法访问目标、IP 路由器无法按当前的传输速率转发数据包等情况时，会自动发送 ICMP 消息。

`ICMP` 的两个重要应用是 `Ping` 和 `Traceroute` ：

+ `Ping` 主要用来测试两台主机之间的连通性。
+ `Traceroute` 用来跟踪一个分组从源点到终点的路径。

假设 **机器 A ping 机器 B**，工作过程如下：
1. ping 通知系统，新建一个固定格式的 ICMP 请求数据包
2. ICMP 协议，将该数据包和目标机器 B 的 IP 地址打包，一起转交给 IP 协议层
3. IP 层协议将本机 IP 地址为源地址，机器 B 的 IP 地址为目标地址，加上一些其他的控制信息，构建一个 IP 数据包
4. 先获取目标机器 B 的 MAC 地址。
5. 数据链路层构建一个数据帧，目的地址是 IP 层传过来的 MAC 地址，源地址是本机的 MAC 地址
6. 机器 B 收到后，对比目标地址，和自己本机的 MAC 地址是否一致，符合就处理返回，不符合就丢弃。
7. 根据目的主机返回的 ICMP 回送回答报文中的时间戳，从而计算出往返时间
8. 最终显示结果有这几项：发送到目的主机的 IP 地址、发送 & 收到 & 丢失的分组数、往返时间的最小、最大 & 平均值


