## 1、CAP 与 最终一致

`CAP` 是分布式系统的理论基石：

+ `C` 代表 **一致性** （Consistent）；
+ `A` 代表 **可用性** （Availability）；
+ `P` 代表 **分区容忍性**（Partition tolerance）。

分布式系统一般都是在不同的机器上通过网络进行交互，但是网络一般都会有断开的风险，网络断开的场景一般称之为 **网络分区** 。

当发生 **网络分区** 时，**一致性** 和 **可用性** 很难两全：

+ 发生`网络分区`，两个分布式节点无法通信，其中一个节点的修改操作无法同步到另一个节点中，两个节点中的数据不同，此时数据的 `一致性` 无法满足；
+ 发生`网络分区`，如果要满足 `一致性`，就需要暂停分布式节点对外的服务，等待网络分区恢复，两个节点正常通信数据保持一致后，再对外提供服务，但此时的 `可用性` 将无法满足。

## 2、Redis 的最终一致性

Redis 的主从节点之间，数据是异步同步的，所以分布式的 Redis 系统并不符合一致性的要求。

即：主从断开连接，主节点依旧可以正常对外提供服务，所以 Redis 符合的是可用性。

Redis 无法保证实时一致性，为保证 `最终一致性`，`从节点`会努力追赶`主节点`的数据，最终在某个时间数据将和`主节点`相同。

如果发生网络分区，主从数据将不一致。当网络恢复后，`从节点`将会通过`多种同步策略`保证与主节点数据一致。

## 3、Redis 同步策略

通过主从同步方式配置Redis集群后，当主节点挂掉，运维将从节点升级为主节点即可继续对外提供服务，可以省去中间的恢复原本主节点的时间，提高了可用性。

Redis 持久化有两种方式，一种是**全量持久化**（RDB），一种是**增量持久化**（AOF）。

Redis 节点之间同步方式也是两种：`全量同步` 与 `增量同步`。

#### 增量同步

增量备份 是将 Redis 具有修改的指令存储至 AOF 日志中。增量同步与增量备份类似：

`增量同步` 是将 `Redis` 具有修改的指令存在`主节点`本地的内存 `Buffer` 中（一个定长的环形数组），然后`异步`将 `Buffer` 中的指令同步到`从节点`。

`从节点` 通过执行 `主节点` 同步过来的指令流，来达到和 `主节点` 一样的状态，同时向`主节点`反馈自己同步到的位置（偏移量）。

`Buffer` 的内存空间是有限的，无限的指令不会一直存在有限的 Buffer 中。

如果 Buffer 数组满了，将会从头开始覆盖前面的内容。

如果因为网络状况不好，从节点短期内无法和主节点进行同步，当网络状况恢复时，buffer中没有被同步的指令很有可能已经被后续的指令覆盖了，从节点无法通过指令流来进行同步追赶保证一致，这时候就需要快照（全量）同步来保证一致性。

#### 全量同步（快照同步）

`全量同步`与快照备份（RDB）类似，首先 `主节点` 执行一次 `bgsave` 命令，在后台异步保存当前数据库的数据到磁盘，然后将文件传送给`从节点`，从节点接收完毕快照文件后，先将当前内存中的数据清空，然后加载 `快照文件` 中的数据，加载完毕以后通知`主节点`继续进行`增量同步`。

> 在快照同步的过程中，主节点的指令buffer还在不停的增加，如果同步的时间过长或者buffer过小，会导致buffer中的指令被新的指令覆盖，这样快照同步完成后依然无法使用增量同步保证一致，此时将继续发起快照同步，这样会出现死循环的情况。
>
> 因此**需要配置一个合适的buffer大小，保证不会出现指令覆盖，防止出现死循环**。

#### 无盘复制同步

主节点进行快照同步时，将文件保存到本地磁盘是一个很耗时的文件IO操作，如果是非SSD磁盘存储，快照同步对系统的负载会造成较大的影响。

从 `Redis2.8.18` 开始，`Redis` 支持无盘复制，`快照同步`将**不会**进行磁盘操作，生产快照是一个遍历内存的过程，`主节点`一边遍历一边将序列化的内容发送给`从节点`，`从节点`将接收的内容存在磁盘文件中，最后进行一次性加载。

> 当有新的从节点加入时，将进行一次快照同步，后续则是增量同步。